{"version":3,"sources":["index.js"],"names":["Page","data","address","cart","totalPrice","totalNum","onShow","wx","getStorageSync","filter","v","checked","all","provinceName","cityName","countyName","detailInfo","forEach","goods_price","num","setData","setStorageSync","handleOrderPay","token","navigateTo","url","console","log","header","Authorization","order_price","consignee_addr","goods","push","goods_id","goods_number","goods_num","orderParams","method","res"],"mappings":"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","sourcesContent":["/**\n  支付页面业务逻辑分析：\n  页面加载的时候\n    从缓存中获取购物车数据 渲染到页面中(checked为true)\n  微信支付\n    企业账号\n    企业账号的后台中必须给开发者添加到白名单\n      一个appid可以绑定多个开发者 这些开发者就可以共用appid和开发权限了\n  支付流程\n    创建订单(获取订单编号) -> 准备预支付(获取支付参数) -> 发起微信支付(提交参数) -> 查询订单\n  支付按钮\n    先判断缓存中是否有token\n    没有 跳转页面授权 进行获取token\n    有token 进行剩下的逻辑\n */\n\nimport regeneratorRuntime from \"../../lib/runtime/runtime\";\nimport { request } from \"../../request/request.js\";\n\nPage({\n  data: {\n    address: {},\n    cart: [],\n    totalPrice: 0,\n    totalNum: 0,\n  },\n  onShow() {\n    // 获取缓存中的地址\n    const address = wx.getStorageSync(\"address\");\n    // 获取缓存中的购物车数据\n    let cart = wx.getStorageSync(\"cart\") || [];\n    // 过滤出checked属性 提取出选择的商品\n    cart = cart.filter((v) => v.checked);\n    address.all =\n      address.provinceName +\n      address.cityName +\n      address.countyName +\n      address.detailInfo;\n    let totalPrice = 0;\n    let totalNum = 0;\n    cart.forEach((v) => {\n      totalPrice += v.goods_price * v.num;\n      totalNum += v.num;\n    });\n    // 设置data数据\n    this.setData({\n      cart,\n      totalPrice,\n      totalNum,\n      address,\n    });\n    wx.setStorageSync(\"cart\", cart);\n  },\n  async handleOrderPay() {\n    wx.setStorageSync(\n      \"token\",\n      \"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIzLCJpYXQiOjE1NjQ3MzAwNzksImV4cCI6MTAwMTU2NDczMDA3OH0.YPt-XeLnjV-_1ITaXGY2FhxmCe4NvXuRnRB8OMCfnPo\"\n    );\n    // 判断缓存中有无token\n    const token = wx.getStorageSync(\"token\");\n    if (!token) {\n      // 不存在就跳转页面\n      wx.navigateTo({\n        url: \"/pages/auth/index\",\n      });\n      // 返回\n      return;\n    }\n\n    console.log(\"Yijing cunzai \");\n\n    // 创建订单\n    // 准备请求头\n    const header = { Authorization: token };\n    // 准备请求体参数\n    const order_price = this.data.totalPrice;\n    const consignee_addr = this.data.address.all;\n    let cart = this.data.cart;\n    let goods = [];\n    cart.forEach((v) =>\n      goods.push({\n        goods_id: v.goods_id,\n        goods_number: v.goods_num,\n        goods_price: v.goods_price,\n      })\n    );\n    const orderParams = { order_price, consignee_addr, goods };\n    // 准备发送请求 创建订单 获取订单编号\n    const res = await request({\n      url: \"/my/orders/create\",\n      method: \"post\",\n      data: orderParams,\n      header,\n    });\n    console.log(res);\n  },\n});\n"],"file":"index.dev.js"}